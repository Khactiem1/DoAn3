
@{
    ViewBag.Title = "Nạp tiền vào tài khoản";
    Layout = "~/Views/Shared/_LayoutLogOn.cshtml";
}

<nav class="oriented">
    <div class="grid wide">
        <ul class="oriented__list">
            <li class="oriented-item">
                <a href="@Request.Url.Scheme://@Request.Url.Authority" class="oriented-item oriented-item__link">Trang chủ</a>
            </li>
            <li class="oriented-item">Dịch vụ</li>
            <li class="oriented-item">Nạp ví</li>
            <li class="oriented-item">Thẻ cào</li>
        </ul>
    </div>
</nav>
<section class="rechargecard">
    <div class="grid wide container__rechargecard">
        <h3 class="rechargecard__title">
            Nạp tiền vào ví
        </h3>
        <div class="grid">
            <ul class="row list__card">
                <li class="col l-2-4 m-4 c-6">
                    <div class="card__item  card__item-active">
                        <div class="card__item-logo">
                            <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/logo__tienich/icon4.svg" alt="">
                        </div>
                        <div class="card__item-text">
                            Thẻ Cào
                        </div>
                    </div>
                </li>
                <li class="col l-2-4 m-4 c-6">
                    <a href="@Request.Url.Scheme://@Request.Url.Authority/BuyCard/NapTienBangATM" class="card__item">
                        <div class="card__item-logo">
                            <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/logo__tienich/icon6.svg" alt="">
                        </div>
                        <div class="card__item-text">
                            Thẻ atm
                        </div>
                    </a>
                </li>
            </ul>
            <div class="container__pay">
                <form class="pay">
                    <h3 class="rechargecard__content-title">
                        Gạch thẻ
                    </h3>
                    <div class="row list__select">
                        <div class="col l-3 m-12 c-12 list__input-items">
                            <select class="select__input">

                                @for (int i = 0; i < ViewBag.DSNhaMang.Count; i++)
                                {
                                    <option>@ViewBag.DSNhaMang[i].TenNhaMang</option>
                                }
                            </select>
                        </div>
                        <div class="col l-3 m-12 c-12 list__input-items">
                            <input maxlength="13" class="select__input" placeholder="Mã thẻ">
                            <span class="form-message mess__code">
                            </span>
                        </div>
                        <div class="col l-3 m-12 c-12 list__input-items">
                            <input maxlength="13" class="select__input" placeholder="Serial">
                            <span class="form-message mess__code">
                            </span>
                        </div>
                        <div class="col l-3 m-12 c-12 list__input-items">
                            <select class="select__input">
                                <option>Mệnh giá</option>
                                <option value="10000">10,000đ</option>
                                <option value="20000">20,000đ</option>
                                <option value="30000">30,000đ</option>
                                <option value="50000">50,000đ</option>
                                <option value="100000">100,000đ</option>
                                <option value="200000">200,000đ</option>
                                <option value="300000">300,000đ</option>
                                <option value="500000">500,000đ</option>
                                <option value="1000000">1,000,000đ</option>
                            </select>
                            <span class="form-message mess__code">
                            </span>
                        </div>
                    </div>
                    <div class="buy">
                        <button type="button" class="btn__card-buy">
                            Nạp
                        </button>
                    </div>
                    <h3 class="rechargecard__content-title">
                        Bảng giá (Chiết khấu được cập nhật mới nhất)
                    </h3>
                </form>
            </div>
        </div>
    </div>
    <div class="grid rechargecard__history-content">
        <div style="display: flex; flex-wrap: wrap;" class="history-content">
            <div class="history-title__item">
                Nhà mạng
            </div>
            <div class="history-title__item">
                10.000
            </div>
            <div class="history-title__item">
                20.000
            </div>
            <div class="history-title__item">
                30.000
            </div>
            <div class="history-title__item">
                50.000
            </div>
            <div class="history-title__item">
                100.000
            </div>
            <div class="history-title__item">
                200.000
            </div>
            <div class="history-title__item">
                300.000
            </div>
            <div class="history-title__item">
                500.000
            </div>
            <div class="history-title__item">
                1.000.000
            </div>
        </div>
        <div class="card__ChietKhau">
            @{
                foreach (var item in ViewBag.DSNhaMang)
                {
                    <div style="display: flex; flex-wrap: wrap;" class="history-content">
                        <div class="history-title__item item-chietkhau">
                            @item.TenNhaMang
                        </div>
                        @foreach (var items in ViewBag.ChietKhau)
                        {
                            if (items.NhaMang == item.TenNhaMang)
                            {
                                <div class="history-title__item item-chietkhau">
                                    @items.ChietKhauNap
                                </div>
                            }
                        }
                    </div>
                }
            }
        </div>
    </div>
    <div class="grid wide">
        <h3 class="rechargecard__history-title">
            Thẻ đã nạp gần đây
        </h3>
    </div>
    <div class="grid rechargecard__history-content history-Naptien">
        <div style="display: flex; flex-wrap: wrap; border-bottom: solid 1px #ccc;" class="history-content">
            <div class="history-title__item">
                Nhà mạng
            </div>
            <div class="history-title__item">
                Mã thẻ
            </div>
            <div class="history-title__item">
                Mệnh giá
            </div>
            <div class="history-title__item">
                Số tiền thực nhận
            </div>
            <div class="history-title__item">
                Ngày nạp
            </div>
            <div class="history-title__item">
                Trạng thái
            </div>
        </div>
        <div class="card__content">
            @foreach (var item in ViewBag.DSTheNap)
            {
                <div style="display: flex; flex-wrap: wrap;" class="history-content">
                    <div class="history-title__item">
                        @item.NhaMang
                    </div>
                    <div class="history-title__item">
                        @item.MaThe
                    </div>
                    <div class="history-title__item">
                        @String.Format("{0:#,##0.##}", item.MenhGia)
                    </div>
                    <div class="history-title__item">
                        @String.Format("{0:#,##0.##}", double.Parse(item.TienThucNhan)) VNĐ
                    </div>
                    <div class="history-title__item">
                        @item.NgayNap.ToString("dd/MM/yyyy HH:mm:ss")
                    </div>
                    <div class="history-title__item">
                        @item.TrangThai
                    </div>
                </div>
            }
        </div>
    </div>
</section>
<section class="security">
    <div class="grid wide container container__security">
        <div class="section__title">
            <h1 class="section__title-text">
                Thanh toán an toàn - Bảo mật tuyệt đối
            </h1>
        </div>
        <div class="security__nav-header">
            <ul class="security__nav">
                <li class="security__nav-item security__active">
                    <span class="security__nav-text">
                        Bảo chứng ngân hàng
                    </span>
                </li>
                <li class="security__nav-item">
                    <span class="security__nav-text">
                        Bảo mật đa tầng
                    </span>
                </li>
                <li class="security__nav-item">
                    <span class="security__nav-text">
                        Đạt chuẩn quốc tế
                    </span>
                </li>
            </ul>
        </div>
        <div class="row security__content fade security__content-active">
            <div class="col l-6 m-6 c-12 security__content-text">
                <ul class="security__content-text__list">
                    <li class="security__content-item">
                        <div class="security__content-item-icon">
                            <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/logo/check.svg" alt="">
                        </div>
                        <div class="security__content-item-text">
                            Tiền của bạn trong Ví TKSR là TIỀN THẬT và được bảo chứng 100% bởi các NGÂN HÀNG đang hợp tác với Ví TKSR.
                        </div>
                    </li>
                    <li class="security__content-item">
                        <div class="security__content-item-icon">
                            <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/logo/check.svg" alt="">
                        </div>
                        <div class="security__content-item-text">
                            Người dùng TKSR có thể Nạp/Rút tiền từ ngân hàng liên kết bất kỳ lúc nào.
                        </div>
                    </li>
                    <li class="security__content-item">
                        <div class="security__content-item-icon">
                            <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/logo/check.svg" alt="">
                        </div>
                        <div class="security__content-item-text">
                            TKSR đã liên kết trực tiếp với 25 ngân hàng lớn và các tổ chức thẻ quốc tế Visa/Master/JCB.
                        </div>
                    </li>
                </ul>
            </div>
            <div class="col l-6 m-6 c-12 security__content-img">
                <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/BaoMat1.jpg" alt="" class="security__content-img-item">
            </div>
        </div>
        <div class="row security__content">
            <div class="col l-6 m-6 c-12 security__content-text">
                <ul class="security__content-text__list">
                    <li class="security__content-item">
                        <div class="security__content-item-icon">
                            <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/logo/check.svg" alt="">
                        </div>
                        <div class="security__content-item-text">
                            Để đăng nhập, cần nhập mật khẩu 6 số và mã OTP được gửi đến điện thoại. Mỗi lần thanh toán đều cần nhập lại mật khẩu.
                        </div>
                    </li>
                    <li class="security__content-item">
                        <div class="security__content-item-icon">
                            <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/logo/check.svg" alt="">
                        </div>
                        <div class="security__content-item-text">
                            Ứng dụng tự khóa sau 5 phút nếu không sử dụng.
                        </div>
                    </li>
                </ul>
            </div>
            <div class="col l-6 m-6 c-12 security__content-img">
                <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/BaoMat2.jpg" alt="" class="security__content-img-item">
            </div>
        </div>
        <div class="row security__content">
            <div class="col l-6 m-6 c-12 security__content-text">
                <ul class="security__content-text__list">
                    <li class="security__content-item">
                        <div class="security__content-item-icon">
                            <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/logo/check.svg" alt="">
                        </div>
                        <div class="security__content-item-text">
                            Công nghệ bảo mật của Ví TKSR đáp ứng các tiêu chuẩn quốc tế khắt khe nhất trong ngành tài chính ngân hàng, đạt chứng nhận bảo mật toàn cầu PCI DSS cấp độ cao nhất.
                        </div>
                    </li>
                    <li class="security__content-item">
                        <div class="security__content-item-icon">
                            <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/logo/check.svg" alt="">
                        </div>
                        <div class="security__content-item-text">
                            Công nghệ mã hóa đường truyền SSL/TLS đạt chứng nhận quốc tế GlobalSign.
                        </div>
                    </li>
                </ul>
            </div>
            <div class="col l-6 m-6 c-12 security__content-img">
                <img src="@Request.Url.Scheme://@Request.Url.Authority/Assets/img/BaoMat3.jpg" alt="" class="security__content-img-item">
            </div>
        </div>
    </div>
</section>
<script src="@Request.Url.Scheme://@Request.Url.Authority/Assets/js/service.js"></script>
<script src="@Request.Url.Scheme://@Request.Url.Authority/Assets/css/User/NapThe/script.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        //UpdateCard
        (function () {
            setInterval(function () {
                $.ajax({
                    url: "/BuyCard/UpdateTheNap",
                    method: "GET",
                    data: "",
                    contentType: "application/json",
                    dataType: ""
                }).done(function (response) {
                    if (response.Data.status == "OK") {
                        $('.card__content').empty();
                        $.each(response.Data.YeuCauGachThe, function (index, item) {
                            var DateIN = new Date(parseInt(item.NgayNap.replace("/Date(", "").replace(")/", ""), 10));
                            var month = DateIN.getMonth();
                            month++;
                            var strDate = DateIN.getDate() + "/" + month + "/" + DateIN.getFullYear() + " " + DateIN.getHours() + ":" + DateIN.getMinutes() + ":" + DateIN.getSeconds();
                            var html = `<div style="display: flex; flex-wrap: wrap;" class="history-content">
                                            <div class="history-title__item">
                                                ${item.NhaMang}
                                            </div>
                                            <div class="history-title__item">
                                                ${item.MaThe}
                                            </div>
                                            <div class="history-title__item">
                                                ${Number(item.MenhGia).toLocaleString("en")}
                                            </div>
                                            <div class="history-title__item">
                                                ${Number(item.TienThucNhan).toLocaleString("en")} VNĐ
                                            </div>
                                            <div class="history-title__item">
                                                ${strDate}
                                            </div>
                                            <div class="history-title__item">
                                                ${item.TrangThai}
                                            </div>
                                        </div>
                                        `;
                            $('.card__content').append($(html));
                        })
                    }
                }).fail(function () {
                    active__messageNotification('Có lỗi xảy ra, thử lại sau', false);
                })
                $.ajax({
                    url: "/BuyCard/UpdateChietKhau",
                    method: "GET",
                    data: "",
                    contentType: "application/json",
                    dataType: ""
                }).done(function (response) {
                    if (response.Data.status == "OK") {
                        $('.card__ChietKhau').empty();
                        $.each(response.Data.DSNhaMang, function (index, item) {
                            var html = `<div style="display: flex; flex-wrap: wrap;" class="history-content">
                                            <div class="history-title__item item-chietkhau">
                                                ${item.TenNhaMang}
                                            </div>`;
                            $.each(response.Data.DSChietKhau, function (index, items) {
                                if (item.TenNhaMang == items.NhaMang) {
                                    html += `
                                                <div class="history-title__item item-chietkhau">
                                                    ${items.ChietKhauNap}
                                                </div>
                                            `
                                }
                            })
                            html += `</div>`
                            $('.card__ChietKhau').append($(html));
                        })
                    }
                }).fail(function () {
                    active__messageNotification('Có lỗi xảy ra, thử lại sau', false);
                })
            }, 3000)
        })()
    }, false)
    document.addEventListener("DOMContentLoaded", function () {
        const $ = document.querySelector.bind(document);
        const $$ = document.querySelectorAll.bind(document);
        /* Validate */
        (function () {
            const modal = $('.modal');
            const auth__form = $('.auth-form');
            const icon__close = $('.auth-form__icon');
            const modal__overlay = $('.modal__overlay');
            const auth__text = $$('.auth-form__rules-text');
            const buyCard = $('.auth-form__submit-buyCard');
            modal__overlay.onclick = function () {
                modal.classList.remove('modal__active');
                const tab__close = $('.auth-form.auth-form__active');
                tab__close.classList.remove('auth-form__active');
            }
            icon__close.onclick = function () {
                modal.classList.remove('modal__active');
                const tab__close = $('.auth-form.auth-form__active');
                tab__close.classList.remove('auth-form__active');
            }
            const input = document.querySelectorAll('.select__input');
            function remove_oninput(element) {
                var message = element.querySelector('.form-message');
                message.innerText = '';
                element.classList.remove('invalid');
            }
            function add__blur(element, messages) {
                var message = element.querySelector('.form-message');
                message.innerText = messages;
                element.classList.add('invalid');
            }
            setInputFilter(input[1], function (value) {
                return /^\d*$/.test(value)
            });
            setInputFilter(input[2], function (value) {
                return /^\d*$/.test(value)
            });
            var isFormValidNumber = true;
            input.forEach((blurs, index) => {
                blurs.onblur = function () {
                    if (index == 1) {
                        function tests() {
                            return input[1].value.trim().length == 13 ? undefined : `Nhập 13 ký tự`;
                        }
                        if (tests() == null) {
                        }
                        else {
                            var mess = tests();
                            add__blur(input[1].parentElement, mess);
                        }
                    }
                    else if (index == 2) {
                        function tests() {
                            return input[2].value.trim().length >= 10 ? undefined : `Nhập 10 - 13 ký tự`;
                        }
                        if (tests() == null) {
                        }
                        else {
                            var mess = tests();
                            add__blur(input[2].parentElement, mess);
                        }
                    }
                    else if (index == 3) {
                        function tests() {
                            return input[3].value != 'Mệnh giá' ? undefined : `Vui lòng chọn mệnh giá`;
                        }
                        if (tests() == null) {
                        }
                        else {
                            var mess = tests();
                            add__blur(input[3].parentElement, mess);
                        }
                    }
                }
                blurs.oninput = function () {
                    if (index == 1) {
                        remove_oninput(input[1].parentElement);
                        isFormValidNumber = true;
                    }
                    if (index == 2) {
                        remove_oninput(input[2].parentElement);
                        isFormValidNumber = true;
                    }
                    if (index == 3) {
                        remove_oninput(input[3].parentElement);
                        isFormValidNumber = true;
                    }
                }
            })
            const number = document.querySelector('.btn__card-buy');
            number.onclick = function () {
                for (var i = 0; i < input.length; i++) {
                    if (i == 1) {
                        function tests() {
                            return input[1].value.trim().length == 13 ? undefined : `Nhập 13 ký tự`;
                        }
                        if (tests() == null) {
                        }
                        else {
                            var mess = tests();
                            add__blur(input[1].parentElement, mess);
                            isFormValidNumber = false;
                        }
                    }
                    else if (i == 2) {
                        function tests() {
                            return input[2].value.trim().length >= 10 ? undefined : `Nhập 10 - 13 ký tự`;
                        }
                        if (tests() == null) {
                        }
                        else {
                            var mess = tests();
                            add__blur(input[2].parentElement, mess);
                            isFormValidNumber = false;
                        }
                    }
                    else if (i == 3) {
                        function tests() {
                            return input[3].value != 'Mệnh giá' ? undefined : `Vui lòng chọn mệnh giá`;
                        }
                        if (tests() == null) {
                        }
                        else {
                            var mess = tests();
                            add__blur(input[3].parentElement, mess);
                            isFormValidNumber = false;
                        }
                    }
                }
                if (isFormValidNumber == true) {
                    active__Loading(true);
                    var form = new FormData();
                    form.append("NhaMang", input[0].value)
                    form.append("MaThe", input[1].value)
                    form.append("Seri", input[2].value)
                    form.append("MenhGia", input[3].value)
                    form.append("Confirm", "false")
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", '/BuyCard/GetRechargeCard', true);
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            active__Loading(false);
                            var r = xhr.responseText;
                            var j = JSON.parse(r);
                            if (j.Data.status == "ER") {
                                active__messageNotification('Có lỗi xảy ra, thử lại sau', false);
                            }
                            else if (j.Data.status == "lock") {
                                active__messageNotification('Tài khoản đang bị khoá! không thể giao dịch', false);
                            }
                            else {
                                modal.classList.add('modal__active');
                                auth__form.classList.add('auth-form__active');
                                auth__text[1].innerText = "Nhà mạng: " + input[0].value;
                                auth__text[2].innerText = "Mã thẻ: " + input[1].value;
                                auth__text[3].innerText = "Số seri: " + input[2].value;
                                auth__text[4].innerText = "Mệnh giá: " + Number(input[3].value).toLocaleString("en");
                                auth__text[5].innerText = "Số tiền thực nhận: " + Number(j.Data.status).toLocaleString("en") + " VNĐ";
                                buyCard.onclick = function () {
                                    active__Loading(true);
                                    var form = new FormData();
                                    form.append("NhaMang", input[0].value)
                                    form.append("MaThe", input[1].value)
                                    form.append("Seri", input[2].value)
                                    form.append("MenhGia", input[3].value)
                                    form.append("Confirm", "true")
                                    var xhr = new XMLHttpRequest();
                                    xhr.open("POST", '/BuyCard/GetRechargeCard', true);
                                    xhr.onreadystatechange = function () {
                                        if (xhr.readyState == 4 && xhr.status == 200) {
                                            active__Loading(false);
                                            var r = xhr.responseText;
                                            var j = JSON.parse(r);
                                            if (j.Data.status == "ER") {
                                                active__messageNotification('Có lỗi xảy ra, thử lại sau', false);
                                            }
                                            else if (j.Data.status == "lock") {
                                                active__messageNotification('Tài khoản đang bị khoá! không thể giao dịch', false);
                                            }
                                            else {
                                                active__messageNotification('Thẻ của bạn sẽ sớm được duyệt', true);
                                                input[2].value = "";
                                                input[1].value = "";
                                                modal.classList.remove('modal__active');
                                                auth__form.classList.remove('auth-form__active');
                                            }
                                        }
                                    }
                                    xhr.send(form);
                                }
                            }
                        }
                    }
                    xhr.send(form);
                }
            }
        })();
    }, false)
    function setInputFilter(textbox, inputFilter) {
        ["input", "keydown", "keyup", "mousedown", "mouseup", "select", "contextmenu", "drop"].forEach(function (event) {
            textbox.addEventListener(event, function () {
                if (inputFilter(this.value)) {
                    this.oldValue = this.value;
                    this.oldSelectionStart = this.selectionStart;
                    this.oldSelectionEnd = this.selectionEnd;
                } else if (this.hasOwnProperty("oldValue")) {
                    this.value = this.oldValue;
                    this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
                }
            });
        });
    }
</script>